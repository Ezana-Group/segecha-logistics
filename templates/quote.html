{% extends "base.html" %}

{% block title %}Request a Quote - Segecha Group Ltd.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
<!-- Add SF Pro Display font -->
<link rel="stylesheet" href="https://fonts.cdnfonts.com/css/sf-pro-display">
<style>
    /* Global styles */
    body {
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        line-height: 1.47059;
        letter-spacing: -0.022em;
    }

    h1, h2, h3, h4, h5, h6 {
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        letter-spacing: -0.022em;
    }

    /* Header section styling */
    .bg-blue-900 {
        background: #000;
        padding: 120px 0 80px;
    }

    .bg-blue-900 h1 {
        font-size: 56px;
        line-height: 1.07143;
        font-weight: 600;
        letter-spacing: -0.005em;
        margin-bottom: 0.4em;
    }

    .bg-blue-900 p {
        font-size: 28px;
        line-height: 1.10722;
        font-weight: 400;
        letter-spacing: .004em;
        color: rgba(255, 255, 255, 0.8);
    }

    /* Form styling */
    .step-content {
        display: none;
    }

    .step-content.active {
        display: block;
    }

    .step-indicator {
        position: relative;
        display: flex;
        justify-content: space-between;
        margin-bottom: 4rem;
        padding: 0 2rem;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .step-indicator::before {
        content: '';
        position: absolute;
        top: 24px;
        left: 15%;
        right: 15%;
        height: 2px;
        background: rgba(0, 0, 0, 0.1);
        z-index: 1;
    }
    
    .step {
        position: relative;
        z-index: 2;
        flex: 1;
        text-align: center;
        opacity: 0.5;
        transition: all 0.3s ease;
    }
    
    .step.active {
        opacity: 1;
    }
    
    .step.completed {
        opacity: 1;
    }

    .step-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.75rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: rgba(0, 0, 0, 0.05);
        color: #6B7280;
    }
    
    .step.active .step-icon {
        background: #0066CC;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 14px rgba(0, 102, 204, 0.15);
    }
    
    .step.completed .step-icon {
        background: #00B300;
        color: white;
    }

    .step-icon i {
        font-size: 1.25rem;
    }

    .step .font-semibold {
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .step .text-gray-600 {
        font-size: 0.75rem;
    }

    /* Form inputs styling */
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    textarea,
    select {
        font-size: 17px;
        line-height: 1.23536;
        font-weight: 400;
        letter-spacing: -.022em;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background-color: rgba(0, 0, 0, 0.02);
        padding: 12px 16px;
        transition: all 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="tel"]:focus,
    input[type="date"]:focus,
    textarea:focus,
    select:focus {
        border-color: #0066CC;
        background-color: #fff;
        box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1);
    }

    /* Buttons styling */
    button {
        font-size: 17px;
        line-height: 1.17648;
        font-weight: 400;
        letter-spacing: -.022em;
        border-radius: 12px;
        padding: 12px 24px;
        transition: all 0.3s ease;
    }

    .bg-blue-600 {
        background-color: #0066CC !important;
    }

    .bg-blue-600:hover {
        background-color: #0077ED !important;
    }

    /* Section styling */
    .bg-gray-50 {
        background-color: rgba(0, 0, 0, 0.02);
        border-radius: 18px;
        border: none;
    }

    /* Map styling */
    #map {
        width: 100%;
        height: 100%;
        border-radius: 0.75rem;
        background: #f8f9fa;
        border: 1px solid #e5e7eb;
    }

    .map-container {
        margin-top: 2rem;
        height: 400px;
        width: 100%;
    }

    .map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        border-radius: 0.75rem;
    }

    .map-error {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 2;
        border-radius: 0.75rem;
    }

    #distance-info {
        z-index: 400;
        backdrop-filter: blur(4px);
        background-color: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
    }

    #distance-info.visible {
        display: flex !important;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Success modal styling */
    .bg-white {
        border-radius: 18px;
    }

    /* Location pin button */
    .location-pin-button {
        font-size: 15px;
        line-height: 1.23536;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.05);
        border: none;
        transition: all 0.3s ease;
    }

    .location-pin-button:hover {
        background: rgba(0, 0, 0, 0.1);
    }

    .location-pin-button.active {
        background: rgba(0, 102, 204, 0.1);
        color: #0066CC;
    }

    /* Section headings */
    .text-xl {
        font-size: 28px;
        line-height: 1.14286;
        font-weight: 600;
        letter-spacing: .007em;
    }

    /* Labels */
    label {
        font-size: 15px;
        line-height: 1.33341;
        font-weight: 400;
        letter-spacing: -.01em;
        color: #1d1d1f;
    }

    /* Success modal styling */
    #successModal .bg-white {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border-radius: 18px;
    }

    /* Modern Select Styling */
    select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-position: right 0.75rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }

    select:focus {
        border-color: #0057A0;
        box-shadow: 0 0 0 3px rgba(0, 87, 160, 0.1);
    }
    
    /* Modern Input Styling */
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    textarea {
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="tel"]:focus,
    input[type="date"]:focus,
    textarea:focus {
        border-color: #0057A0;
        box-shadow: 0 0 0 3px rgba(0, 87, 160, 0.1);
    }

    /* Pin Button Styling */
    .location-pin-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        background: #f9fafb;
        transition: all 0.3s ease;
        font-size: 0.875rem;
    }

    .location-pin-button:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }

    .location-pin-button.active {
        background: #dbeafe;
        border-color: #0057A0;
        color: #0057A0;
    }
    
    /* Map Popup Styling */
    .map-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 999;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .map-overlay.active {
        display: block;
        opacity: 1;
    }

    .map-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        z-index: 1000;
        display: none;
        opacity: 0;
        transition: all 0.3s ease;
        max-width: 90vw;
        width: 800px;
    }

    .map-popup.active {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }

    .map-search-container {
        position: relative;
        margin-bottom: 1rem;
    }

    .map-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .map-search-result {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .map-search-result:hover {
        background-color: #f3f4f6;
    }

    .map-search-loading {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        display: none;
    }

    /* Address Suggestions Styling */
    .address-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 0.5rem 0.5rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 10;
        display: none;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .suggestion-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .suggestion-item:hover {
        background: #f3f4f6;
    }

    /* Map Styling */
    #map {
        height: 400px;
        border-radius: 0.75rem;
        margin-top: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    #distance-info {
        z-index: 400;
        backdrop-filter: blur(4px);
        background-color: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
    }

    #distance-info.visible {
        display: flex !important;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Fix map loading issue */
    #map {
        min-height: 400px;
        width: 100%;
        background: #f8f9fa;
        border: 1px solid #e5e7eb;
    }

    .leaflet-container {
        z-index: 1;
    }

    .map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        border-radius: 0.75rem;
    }

    .map-error {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 2;
        border-radius: 0.75rem;
    }

    /* Form transitions */
    .step-content {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
        display: none;
    }

    .step-content.active {
        opacity: 1;
        transform: translateY(0);
        display: block;
    }

    /* Validation styles */
    .error {
        border-color: #EF4444 !important;
        background-color: #FEF2F2 !important;
    }

    .error:focus {
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1) !important;
    }

    .error-message {
        animation: fadeIn 0.3s ease;
    }

    /* Step transitions */
    .step-content {
        transition: opacity 0.3s ease;
    }

    .step-content.active {
        animation: slideIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateX(10px); }
        to { opacity: 1; transform: translateX(0); }
    }

    /* Progress bar */
    .progress-container {
        width: 100%;
        height: 4px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 2px;
        margin: 2rem 0;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: #0066CC;
        transition: width 0.3s ease;
    }

    .step-counter {
        font-size: 0.875rem;
        color: #6B7280;
        text-align: center;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<section class="bg-blue-900 text-white py-20">
    <div class="container mx-auto px-4">
        <h1 class="text-4xl font-bold mb-4">Request a Quote</h1>
        <p class="text-xl">Get a customized transportation quote for your cargo</p>
    </div>
</section>

<!-- Quote Form Section -->
<section class="py-16">
    <div class="container mx-auto px-4">
        <div class="flex justify-center mb-8">
            <img src="{{ url_for('static', filename='images/logo-main.png') }}" alt="Segecha Group Logo" class="h-20 w-auto">
        </div>
        <div class="max-w-4xl mx-auto">
            <!-- Step Indicators -->
            <div class="step-indicator mb-12">
                <div class="step active">
                    <div class="step-icon">
                        <i class="fas fa-map-marker-alt text-xl"></i>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold">Step 1</div>
                        <div class="text-sm text-gray-600">Locations</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-icon">
                        <i class="fas fa-box text-xl"></i>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold">Step 2</div>
                        <div class="text-sm text-gray-600">Cargo Details</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-icon">
                        <i class="fas fa-user text-xl"></i>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold">Step 3</div>
                        <div class="text-sm text-gray-600">Your Details</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-8">
                <!-- Form -->
                <div>
                    <form method="POST" id="quote-form" class="bg-white p-8 rounded-lg shadow-lg">
                        <!-- Hidden fields for coordinates and distance -->
                        <input type="hidden" id="estimated_distance" name="estimated_distance" value="">
                        <input type="hidden" id="pickup_lat" name="pickup_lat" value="">
                        <input type="hidden" id="pickup_lng" name="pickup_lng" value="">
                        <input type="hidden" id="dropoff_lat" name="dropoff_lat" value="">
                        <input type="hidden" id="dropoff_lng" name="dropoff_lng" value="">
                        
                        <!-- Additional hidden fields for address information -->
                        <input type="hidden" id="pickup_display_name" name="pickup_display_name" value="">
                        <input type="hidden" id="pickup_coordinates" name="pickup_coordinates" value="">
                        <input type="hidden" id="pickup_formatted_address" name="pickup_formatted_address" value="">
                        <input type="hidden" id="dropoff_display_name" name="dropoff_display_name" value="">
                        <input type="hidden" id="dropoff_coordinates" name="dropoff_coordinates" value="">
                        <input type="hidden" id="dropoff_formatted_address" name="dropoff_formatted_address" value="">

                        <!-- Step 1: Locations -->
                        <div class="step-content active" data-step="1">
                            <h3 class="text-xl font-bold mb-6 flex items-center">
                                <i class="fas fa-map-marker-alt text-blue-600 mr-3"></i>
                                Pickup & Delivery Locations
                            </h3>
                            
                            <!-- Locations Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <!-- Pickup Location -->
                                <div class="bg-gray-50 p-6 rounded-lg">
                                    <h4 class="text-lg font-semibold mb-4 flex items-center">
                                        <i class="fas fa-truck-loading text-blue-600 mr-2"></i>
                                        Pickup Location
                                    </h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-gray-700 mb-2" for="pickup_country">Country *</label>
                                            <select id="pickup_country" name="pickup_country" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                                <option value="">Select Country</option>
                                                {% for country in countries %}
                                                <option value="{{ country }}">{{ country }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2" for="pickup_city">City/Town *</label>
                                            <select id="pickup_city" name="pickup_city" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                                <option value="">Select City</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2" for="pickup_address">Specific Address *</label>
                                            <div class="flex gap-2">
                                                <div class="address-input-container flex-1">
                                                    <input type="text" id="pickup_address" name="pickup_address" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="Start typing to search address..." autocomplete="off">
                                                    <div id="pickup_suggestions" class="address-suggestions"></div>
                                                </div>
                                                <button type="button" id="pickup_map_button" class="location-pin-button" onclick="startLocationSelection('pickup')">
                                                    <i class="fas fa-map-marker-alt text-blue-600"></i>
                                                    Pin on Map
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Drop-off Location -->
                                <div class="bg-gray-50 p-6 rounded-lg">
                                    <h4 class="text-lg font-semibold mb-4 flex items-center">
                                        <i class="fas fa-truck-unloading text-blue-600 mr-2"></i>
                                        Drop-off Location
                                    </h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-gray-700 mb-2" for="dropoff_country">Country *</label>
                                            <select id="dropoff_country" name="dropoff_country" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                                <option value="">Select Country</option>
                                                {% for country in countries %}
                                                <option value="{{ country }}">{{ country }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2" for="dropoff_city">City/Town *</label>
                                            <select id="dropoff_city" name="dropoff_city" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                                <option value="">Select City</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 mb-2" for="dropoff_address">Specific Address *</label>
                                            <div class="flex gap-2">
                                                <div class="address-input-container flex-1">
                                                    <input type="text" id="dropoff_address" name="dropoff_address" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="Start typing to search address..." autocomplete="off">
                                                    <div id="dropoff_suggestions" class="address-suggestions"></div>
                                                </div>
                                                <button type="button" id="dropoff_map_button" class="location-pin-button" onclick="startLocationSelection('dropoff')">
                                                    <i class="fas fa-map-marker-alt text-blue-600"></i>
                                                    Pin on Map
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Map Section -->
                            <div class="w-full">
                                <div class="relative h-[400px]">
                                    <div id="map" class="w-full h-full rounded-lg"></div>
                                    <div class="map-loading">
                                        <div class="spinner"></div>
                                    </div>
                                    <div class="map-error">
                                        <p><i class="fas fa-exclamation-triangle mr-2"></i>Unable to load map</p>
                                        <button class="text-sm text-blue-600 hover:text-blue-800 mt-2" onclick="retryLoadMap()">
                                            Retry
                                        </button>
                                    </div>
                                    <div id="distance-info" class="absolute bottom-4 left-4 bg-white px-4 py-2 rounded-lg shadow-lg hidden">
                                        <div class="flex items-center">
                                            <i class="fas fa-route text-blue-600 mr-2"></i>
                                            <span>Estimated Distance: <span id="distance-value" class="font-semibold">0</span> km</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-8 flex justify-end">
                                <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors" onclick="nextStep(1)">
                                    Next Step
                                    <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Cargo Information -->
                        <div class="step-content" data-step="2">
                            <h3 class="text-xl font-bold mb-6 flex items-center">
                                <i class="fas fa-box text-blue-600 mr-3"></i>
                                Cargo Information
                            </h3>

                            <div class="space-y-6">
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2" for="cargo_description">
                                        <i class="fas fa-box-open text-blue-600 mr-2"></i>Cargo Description *
                                    </label>
                                    <textarea id="cargo_description" 
                                              name="cargo_description" 
                                              required 
                                              rows="4" 
                                              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                              placeholder="Please describe your cargo (type, dimensions, weight if known)"></textarea>
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2" for="preferred_date">
                                        <i class="fas fa-calendar text-blue-600 mr-2"></i>Preferred Pickup Date
                                    </label>
                                    <input type="date" 
                                           id="preferred_date" 
                                           name="preferred_date" 
                                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2" for="additional_notes">
                                        <i class="fas fa-comment text-blue-600 mr-2"></i>Special Requirements
                                    </label>
                                    <textarea id="additional_notes" 
                                              name="additional_notes" 
                                              rows="3" 
                                              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                              placeholder="Any special handling requirements or additional information"></textarea>
                                </div>
                            </div>

                            <div class="mt-8 flex justify-between">
                                <button type="button" 
                                        class="border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-bold py-3 px-8 rounded-lg transition-colors"
                                        onclick="previousStep(2)">
                                    <i class="fas fa-arrow-left mr-2"></i>
                                    Previous
                                </button>
                                <button type="button" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors"
                                        onclick="nextStep(2)">
                                    Next Step
                                    <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Personal Information -->
                        <div class="step-content" data-step="3">
                            <h3 class="text-xl font-bold mb-6 flex items-center">
                                <i class="fas fa-user text-blue-600 mr-3"></i>
                                Your Details
                            </h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2" for="name">
                                        <i class="fas fa-user text-blue-600 mr-2"></i>Full Name *
                                    </label>
                                    <input type="text" 
                                           id="name" 
                                           name="name" 
                                           required 
                                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2" for="company">
                                        <i class="fas fa-building text-blue-600 mr-2"></i>Company Name
                                    </label>
                                    <input type="text" 
                                           id="company" 
                                           name="company" 
                                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2" for="email">
                                        <i class="fas fa-envelope text-blue-600 mr-2"></i>Email Address *
                                    </label>
                                    <input type="email" 
                                           id="email" 
                                           name="email" 
                                           required 
                                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2" for="phone">
                                        <i class="fas fa-phone text-blue-600 mr-2"></i>Phone Number *
                                    </label>
                                    <input type="tel" 
                                           id="phone" 
                                           name="phone" 
                                           required 
                                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                </div>
                            </div>

                            <div class="mt-8 flex justify-between">
                                <button type="button" 
                                        class="border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-bold py-3 px-8 rounded-lg transition-colors"
                                        onclick="previousStep(3)">
                                    <i class="fas fa-arrow-left mr-2"></i>
                                    Previous
                                </button>
                                <button type="submit" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors">
                                    Submit Quote Request
                                    <i class="fas fa-check ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 relative">
            <!-- Add close button -->
            <button type="button" 
                    onclick="closeSuccessModal()" 
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Thank You!</h2>
                <div class="space-y-6">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-2xl text-green-500"></i>
                        </div>
                        <p class="text-gray-600">Your quote request has been submitted successfully!</p>
                        <p class="text-gray-600 mt-2">A confirmation email has been sent to your email address.</p>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4">What Happens Next?</h3>
                        <ul class="space-y-4">
                            <li class="flex items-start">
                                <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center mr-3">
                                    1
                                </div>
                                <p class="text-gray-600">We'll review your request within 24 hours</p>
                            </li>
                            <li class="flex items-start">
                                <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center mr-3">
                                    2
                                </div>
                                <p class="text-gray-600">Our team will prepare a detailed quote</p>
                            </li>
                            <li class="flex items-start">
                                <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center mr-3">
                                    3
                                </div>
                                <p class="text-gray-600">We'll contact you to discuss the details</p>
                            </li>
                        </ul>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold mb-2">Need Immediate Assistance?</h3>
                        <p class="text-gray-600 mb-4">Contact our team directly:</p>
                        <div class="space-y-2">
                            <p>
                                <i class="fas fa-phone text-blue-600 mr-2"></i>
                                <a href="tel:{{ config.CONTACT_PHONE_1|replace(' ', '') }}" class="hover:underline text-blue-600">{{ config.CONTACT_PHONE_1 }}</a>
                            </p>
                            <p>
                                <i class="fas fa-envelope text-blue-600 mr-2"></i>
                                <a href="mailto:{{ config.CONTACT_EMAIL }}" class="hover:underline text-blue-600">{{ config.CONTACT_EMAIL }}</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add the map popup -->
<div class="map-overlay" id="mapOverlay"></div>
<div class="map-popup" id="mapPopup" 
     data-cities='{{ EAST_AFRICAN_CITIES|tojson|safe }}'>
    <div class="space-y-4">
        <h3 class="text-xl font-bold">Select Location on Map</h3>
        <p class="text-gray-600">Click on the map to place a marker for your selected location.</p>
        
        <!-- Add search box -->
        <div class="map-search-container">
            <input type="text" 
                   id="mapSearchInput" 
                   class="w-full px-4 py-2.5 border rounded-lg focus:outline-none focus:border-blue-500"
                   placeholder="Search for an address..."
                   autocomplete="off">
            <div class="map-search-loading">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
            </div>
            <div id="mapSearchResults" class="map-search-results"></div>
        </div>

        <div id="popupMap" class="h-[400px] w-full rounded-lg overflow-hidden"></div>
        <div class="flex justify-between pt-4">
            <button type="button" 
                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2.5 rounded-lg transition-colors"
                    onclick="cancelLocationSelection()">
                Cancel
            </button>
            <button type="button" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg transition-colors"
                    onclick="confirmLocationSelection()">
                Confirm Location
            </button>
        </div>
    </div>
</div>

<!-- Add progress bar -->
<div class="progress-container">
    <div class="progress-bar" style="width: 33.33%"></div>
</div>
<div class="step-counter">Step 1 of 3</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Initialize cities data from server
const EAST_AFRICAN_CITIES_DATA = JSON.parse('{{ EAST_AFRICAN_CITIES|tojson|safe }}');

let map = null;
let popupMap = null;
let pickupMarker = null;
let dropoffMarker = null;
let routeLine = null;
let tempMarker = null;
let currentLocationSelection = null;
let EAST_AFRICAN_CITIES = EAST_AFRICAN_CITIES_DATA;
let currentRouteType = 'air';

// Add these variables to track selected cities
let selectedPickupCity = null;
let selectedDropoffCity = null;

// Initialize everything when the document is ready
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Initialize main map
        initializeMainMap();
        
        // Initialize form handlers
        initializeFormHandlers();
        
        // Hide loading spinner
        const loadingSpinner = document.querySelector('.map-loading');
        if (loadingSpinner) {
            loadingSpinner.style.display = 'none';
        }
    } catch (error) {
        console.error('Error initializing maps:', error);
        showMapError();
    }
});

function initializeMainMap() {
    try {
        // Initialize main map centered on East Africa
        map = L.map('map', {
            zoomControl: true,
            scrollWheelZoom: true
        }).setView([-1.2921, 36.8219], 6);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Initialize markers but don't add to map yet
        pickupMarker = L.marker([0, 0], { 
            draggable: true,
            title: 'Pickup Location'
        });

        dropoffMarker = L.marker([0, 0], { 
            draggable: true,
            title: 'Delivery Location'
        });

        // Add drag event listeners
        pickupMarker.on('dragend', function(e) {
            updateMarkerPosition('pickup', e.target.getLatLng());
        });

        dropoffMarker.on('dragend', function(e) {
            updateMarkerPosition('dropoff', e.target.getLatLng());
        });

        // Hide loading spinner
        document.querySelector('.map-loading').style.display = 'none';
        
        return true;
    } catch (error) {
        console.error('Error initializing map:', error);
        showMapError();
        return false;
    }
}

function initializeFormHandlers() {
    // Add event listeners for country selects
    ['pickup', 'dropoff'].forEach(type => {
        const countrySelect = document.getElementById(`${type}_country`);
        if (countrySelect) {
            countrySelect.addEventListener('change', () => updateCities(type));
        }

        const citySelect = document.getElementById(`${type}_city`);
        if (citySelect) {
            citySelect.addEventListener('change', () => updateMapForCity(type));
        }
    });

    // Form validation
    const form = document.getElementById('quote-form');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate all required fields
            if (!validateAllSteps()) {
                return;
            }
            
            try {
                // Create FormData object
                const formData = new FormData(this);
                
                // Submit form via AJAX
                const response = await fetch('/quote', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Hide the form section
                    const formSection = document.querySelector('.py-16');
                    formSection.style.display = 'none';
                    
                    // Show success modal
                    const successModal = document.getElementById('successModal');
                    successModal.classList.remove('hidden');
                    
                    // Update browser history to prevent going back to form
                    window.history.pushState({}, '', '/quote-submitted');
                    
                    // Scroll to top of success message
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                } else {
                    alert('An error occurred while submitting your request. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('An error occurred while submitting your request. Please try again.');
            }
        });
    }
}

function updateCities(type) {
    const countrySelect = document.getElementById(`${type}_country`);
    const citySelect = document.getElementById(`${type}_city`);
    const country = countrySelect.value;
    
    // Store the current address before updating cities
    const currentAddress = document.getElementById(`${type}_address`).value;
    const currentLat = document.getElementById(`${type}_lat`).value;
    const currentLng = document.getElementById(`${type}_lng`).value;
    
    // Clear current options
    citySelect.innerHTML = '<option value="">Select City</option>';
    
    if (country && EAST_AFRICAN_CITIES && EAST_AFRICAN_CITIES[country]) {
        Object.keys(EAST_AFRICAN_CITIES[country]).forEach(city => {
            // Skip if this city is already selected in the other location
            if ((type === 'pickup' && city === selectedDropoffCity) ||
                (type === 'dropoff' && city === selectedPickupCity)) {
                return;
            }
            
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
        });
        citySelect.disabled = false;
        
        // Dispatch a custom event when cities are loaded
        citySelect.dispatchEvent(new CustomEvent('citiesLoaded'));
    } else {
        citySelect.disabled = true;
    }
}

function updateMapForCity(type) {
    const country = document.getElementById(`${type}_country`).value;
    const city = document.getElementById(`${type}_city`).value;
    
    if (!country || !city || !EAST_AFRICAN_CITIES[country] || !EAST_AFRICAN_CITIES[country][city]) {
        return;
    }

    const coords = EAST_AFRICAN_CITIES[country][city];
    const latlng = L.latLng(coords.lat, coords.lng);
    
    // Update marker
    const marker = type === 'pickup' ? pickupMarker : dropoffMarker;
    
    if (!marker.getLatLng()) {
        marker.addTo(map);
    }
    marker.setLatLng(latlng);
    
    // Update form values
    document.getElementById(`${type}_lat`).value = coords.lat;
    document.getElementById(`${type}_lng`).value = coords.lng;
    document.getElementById(`${type}_address`).value = `${city}, ${country}`;
    
    // Update map view
    if (pickupMarker.getLatLng() && dropoffMarker.getLatLng()) {
        updateRoute();
    } else {
        map.setView(latlng, 12);
    }
}

function startLocationSelection(type) {
    currentLocationSelection = type;
    
    // Show overlay and popup
    document.getElementById('mapOverlay').classList.add('active');
    document.getElementById('mapPopup').classList.add('active');
    
    // Initialize search functionality
    const searchInput = document.getElementById('mapSearchInput');
    const searchResults = document.getElementById('mapSearchResults');
    const searchLoading = document.querySelector('.map-search-loading');
    
    // Clear previous search
    searchInput.value = '';
    searchResults.style.display = 'none';
    
    // Initialize popup map if it doesn't exist
    if (!popupMap) {
        popupMap = L.map('popupMap').setView([-1.2921, 36.8219], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(popupMap);
        
        // Add click handler
        popupMap.on('click', async function(e) {
            if (tempMarker) {
                popupMap.removeLayer(tempMarker);
            }
            tempMarker = L.marker(e.latlng).addTo(popupMap);
            
            // Get address for clicked location
            const addressData = await getAddressFromCoordinates(e.latlng.lat, e.latlng.lng);
            if (addressData) {
                tempMarker.address = {
                    display_name: addressData.display_name,
                    lat: e.latlng.lat,
                    lon: e.latlng.lng,
                    address: addressData.address || {}
                };
                // Update search input with the address
                searchInput.value = addressData.display_name;
                // Update country and city fields
                await updateLocationFields(currentLocationSelection, tempMarker.address);
            }
        });
    }
    
    // Center map on current marker if it exists
    const currentMarker = type === 'pickup' ? pickupMarker : dropoffMarker;
    if (currentMarker && currentMarker.getLatLng()) {
        popupMap.setView(currentMarker.getLatLng(), 12);
        if (tempMarker) {
            popupMap.removeLayer(tempMarker);
        }
        tempMarker = L.marker(currentMarker.getLatLng()).addTo(popupMap);
        if (currentMarker.address) {
            searchInput.value = currentMarker.address.display_name;
        }
    }
    
    // Initialize search input handler
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        // Hide previous results
        searchResults.style.display = 'none';
        
        if (query.length < 3) {
            searchLoading.style.display = 'none';
            return;
        }
        
        // Show loading indicator
        searchLoading.style.display = 'block';
        
        // Set new timeout for search
        searchTimeout = setTimeout(() => {
            searchAddress(query);
        }, 500);
    });
    
    // Force map refresh
    setTimeout(() => {
        popupMap.invalidateSize();
    }, 100);
}

function cancelLocationSelection() {
    document.getElementById('mapOverlay').classList.remove('active');
    document.getElementById('mapPopup').classList.remove('active');
    
    if (tempMarker && popupMap) {
        popupMap.removeLayer(tempMarker);
        tempMarker = null;
    }
}

function confirmLocationSelection() {
    if (!tempMarker) {
        alert('Please select a location on the map first.');
        return;
    }

    const marker = currentLocationSelection === 'pickup' ? pickupMarker : dropoffMarker;
    const latlng = tempMarker.getLatLng();
    
    // Update marker
    if (!marker.getLatLng()) {
        marker.addTo(map);
    }
    marker.setLatLng(latlng);
    
    // Store address information
    marker.address = tempMarker.address;
    
    // Update form values
    const addressInfo = tempMarker.address;
    if (addressInfo) {
        // Update coordinates
        document.getElementById(`${currentLocationSelection}_lat`).value = addressInfo.lat;
        document.getElementById(`${currentLocationSelection}_lng`).value = addressInfo.lon;
        
        // Update address field
        document.getElementById(`${currentLocationSelection}_address`).value = addressInfo.display_name;
        
        // Update hidden fields with full address information
        document.getElementById(`${currentLocationSelection}_display_name`).value = addressInfo.display_name;
        document.getElementById(`${currentLocationSelection}_coordinates`).value = `${addressInfo.lat},${addressInfo.lon}`;
        document.getElementById(`${currentLocationSelection}_formatted_address`).value = addressInfo.display_name;
    }
    
    // Update route if both markers exist
    if (pickupMarker.getLatLng() && dropoffMarker.getLatLng()) {
        updateRoute();
    }
    
    cancelLocationSelection();
}

function updateMarkerPosition(type, latlng) {
    // Update form values
    document.getElementById(`${type}_lat`).value = latlng.lat;
    document.getElementById(`${type}_lng`).value = latlng.lng;
    document.getElementById(`${type}_address`).value = 
        `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    
    // Update route if both markers exist
    if (pickupMarker.getLatLng() && dropoffMarker.getLatLng()) {
        updateRoute();
    }
}

function generateGreatCircle(start, end) {
    const points = [];
    const numPoints = 100;
    
    for (let i = 0; i <= numPoints; i++) {
        const fraction = i / numPoints;
        const lat = start.lat + (end.lat - start.lat) * fraction;
        const lng = start.lng + (end.lng - start.lng) * fraction;
        
        // Add some curvature based on distance and latitude
        const midPoint = i === numPoints / 2;
        const curveIntensity = 0.2; // Adjust this value to change curve intensity
        let curvedLat = lat;
        
        if (i > 0 && i < numPoints) {
            const latDistance = Math.abs(end.lat - start.lat);
            const lngDistance = Math.abs(end.lng - start.lng);
            const distance = Math.sqrt(latDistance * latDistance + lngDistance * lngDistance);
            const curve = Math.sin(Math.PI * fraction) * distance * curveIntensity;
            curvedLat = lat + curve;
        }
        
        points.push([curvedLat, lng]);
    }
    
    return points;
}

async function getRoadRoute(start, end) {
    try {
        const params = new URLSearchParams({
            start_lng: start.lng,
            start_lat: start.lat,
            end_lng: end.lng,
            end_lat: end.lat
        });
        
        const response = await fetch(`/get_route?${params}`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Unable to get road route');
        }
        
        // Decode the polyline
        const points = L.Polyline.fromEncoded(data.geometry).getLatLngs();
        return {
            points: points,
            distance: data.distance // Already in kilometers
        };
    } catch (error) {
        console.error('Error getting road route:', error);
        return null;
    }
}

async function updateRoute() {
    const pickup = pickupMarker.getLatLng();
    const dropoff = dropoffMarker.getLatLng();
    
    // Remove existing route line
    if (routeLine) {
        map.removeLayer(routeLine);
    }
    
    // Generate curved great circle route
    const routePoints = generateGreatCircle(pickup, dropoff);
    const distance = calculateDistance(pickup.lat, pickup.lng, dropoff.lat, dropoff.lng);
    
    // Create the route line with gradient
    routeLine = L.polyline(routePoints, {
        color: '#0057A0',
        weight: 3,
        opacity: 0.8,
        lineCap: 'round',
        lineJoin: 'round'
    }).addTo(map);
    
    // Fit bounds to show the entire route
    const bounds = L.latLngBounds(routePoints);
    map.fitBounds(bounds.pad(0.1));
    
    // Update distance display
    document.getElementById('estimated_distance').value = Math.round(distance);
    document.getElementById('distance-value').textContent = Math.round(distance);
    document.getElementById('distance-info').classList.add('visible');
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
             Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
             Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return Math.round(R * c);
}

function showMapError() {
    const mapError = document.querySelector('.map-error');
    const mapLoading = document.querySelector('.map-loading');
    
    if (mapLoading) {
        mapLoading.style.display = 'none';
    }
    if (mapError) {
        mapError.style.display = 'flex';
    }
}

function nextStep(currentStep) {
    // Validate current step before proceeding
    if (currentStep === 1 && !validateStep1()) {
        return;
    }
    
    // Get all step elements
    const steps = document.querySelectorAll('.step');
    const contents = document.querySelectorAll('.step-content');
    
    // Hide current step content with fade out
    contents[currentStep - 1].style.opacity = '0';
    setTimeout(() => {
        contents[currentStep - 1].classList.remove('active');
        
        // Show next step content with fade in
        contents[currentStep].classList.add('active');
        contents[currentStep].style.opacity = '0';
        setTimeout(() => {
            contents[currentStep].style.opacity = '1';
        }, 50);
    }, 300);
    
    // Update step indicators
    steps[currentStep - 1].classList.add('completed');
    steps[currentStep].classList.add('active');
    
    // Update progress
    updateProgress(currentStep + 1);
    
    // Scroll to top of form
    document.querySelector('.quote-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function previousStep(currentStep) {
    // Get all step elements
    const steps = document.querySelectorAll('.step');
    const contents = document.querySelectorAll('.step-content');
    
    // Hide current step content with fade out
    contents[currentStep - 1].style.opacity = '0';
    setTimeout(() => {
        contents[currentStep - 1].classList.remove('active');
        
        // Show previous step content with fade in
        contents[currentStep - 2].classList.add('active');
        contents[currentStep - 2].style.opacity = '0';
        setTimeout(() => {
            contents[currentStep - 2].style.opacity = '1';
        }, 50);
    }, 300);
    
    // Update step indicators
    steps[currentStep - 1].classList.remove('active');
    steps[currentStep - 2].classList.remove('completed');
    steps[currentStep - 2].classList.add('active');
    
    // Update progress
    updateProgress(currentStep - 1);
    
    // Scroll to top of form
    document.querySelector('.quote-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function updateProgress(step) {
    const totalSteps = 3;
    const progress = (step / totalSteps) * 100;
    
    // Update progress bar
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.width = `${progress}%`;
    }
    
    // Update step counter
    const stepCounter = document.querySelector('.step-counter');
    if (stepCounter) {
        stepCounter.textContent = `Step ${step} of ${totalSteps}`;
    }
}

function validateStep(step) {
    let isValid = true;
    const stepContent = document.querySelector(`.step-content[data-step="${step}"]`);
    
    // Get all required inputs in current step
    const requiredInputs = stepContent.querySelectorAll('[required]');
    
    requiredInputs.forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('border-red-500');
            isValid = false;
            
            // Add shake animation
            input.classList.add('animate-shake');
            setTimeout(() => {
                input.classList.remove('animate-shake');
            }, 500);
        } else {
            input.classList.remove('border-red-500');
        }
    });
    
    if (!isValid) {
        // Show error message
        const errorMsg = stepContent.querySelector('.error-message') || document.createElement('div');
        errorMsg.className = 'text-red-500 text-sm mt-4 error-message';
        errorMsg.textContent = 'Please fill in all required fields before proceeding.';
        
        if (!stepContent.querySelector('.error-message')) {
            stepContent.appendChild(errorMsg);
        }
    }
    
    return isValid;
}

function validateAllSteps() {
    let isValid = true;
    
    // Validate Step 1: Locations
    ['pickup', 'dropoff'].forEach(type => {
        ['country', 'city', 'address'].forEach(field => {
            const input = document.getElementById(`${type}_${field}`);
            if (!input.value) {
                input.classList.add('border-red-500');
                isValid = false;
            } else {
                input.classList.remove('border-red-500');
            }
        });
    });
    
    // Validate Step 2: Cargo Details
    const cargoDesc = document.getElementById('cargo_description');
    if (!cargoDesc.value) {
        cargoDesc.classList.add('border-red-500');
        isValid = false;
    } else {
        cargoDesc.classList.remove('border-red-500');
    }
    
    // Validate Step 3: Personal Information
    ['name', 'email', 'phone'].forEach(field => {
        const input = document.getElementById(field);
        if (!input.value) {
            input.classList.add('border-red-500');
            isValid = false;
        } else {
            input.classList.remove('border-red-500');
        }
    });
    
    if (!isValid) {
        alert('Please fill in all required fields before submitting.');
    }
    
    return isValid;
}

function retryLoadMap() {
    document.querySelector('.map-error').style.display = 'none';
    document.querySelector('.map-loading').style.display = 'flex';
    
    setTimeout(() => {
        if (initializeMainMap()) {
            // If map was initialized successfully, try to restore markers
            if (pickupMarker && pickupMarker.getLatLng()) {
                pickupMarker.addTo(map);
            }
            if (dropoffMarker && dropoffMarker.getLatLng()) {
                dropoffMarker.addTo(map);
            }
            if (pickupMarker.getLatLng() && dropoffMarker.getLatLng()) {
                updateRoute();
            }
        }
    }, 1000);
}

// Add these functions after the existing JavaScript code
let searchTimeout = null;
const searchInput = document.getElementById('mapSearchInput');
const searchResults = document.getElementById('mapSearchResults');
const searchLoading = document.querySelector('.map-search-loading');

// Add event listener for search input
if (searchInput) {
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        // Hide previous results
        searchResults.style.display = 'none';
        
        if (query.length < 3) {
            searchLoading.style.display = 'none';
            return;
        }
        
        // Show loading indicator
        searchLoading.style.display = 'block';
        
        // Set new timeout for search
        searchTimeout = setTimeout(() => {
            searchAddress(query);
        }, 500);
    });
}

// Function to search for addresses
async function searchAddress(query) {
    try {
        // Get the current map bounds to bias the search
        const bounds = popupMap.getBounds();
        
        const params = new URLSearchParams({
            query: query,
            country: ''  // We can add country filter if needed
        });
        
        const response = await fetch(`/search_address?${params}`);
        const results = await response.json();
        
        // Hide loading indicator
        const searchLoading = document.querySelector('.map-search-loading');
        searchLoading.style.display = 'none';
        
        // Get results container
        const searchResults = document.getElementById('mapSearchResults');
        
        // Clear previous results
        searchResults.innerHTML = '';
        
        if (results.length > 0) {
            // Show results container
            searchResults.style.display = 'block';
            
            // Add results
            results.slice(0, 5).forEach(result => {
                const div = document.createElement('div');
                div.className = 'map-search-result hover:bg-gray-100 cursor-pointer';
                div.textContent = result.display_name;
                div.addEventListener('click', () => {
                    selectSearchResult(result);
                });
                searchResults.appendChild(div);
            });
        }
    } catch (error) {
        console.error('Error searching for address:', error);
        const searchLoading = document.querySelector('.map-search-loading');
        searchLoading.style.display = 'none';
    }
}

// Function to update location fields
async function updateLocationFields(type, addressInfo) {
    if (!addressInfo || !addressInfo.address) return;

    const country = addressInfo.address.country;
    const city = addressInfo.address.city || 
                addressInfo.address.town || 
                addressInfo.address.village || 
                addressInfo.address.suburb ||
                addressInfo.address.county ||
                addressInfo.address.state_district;

    // Update address field with the full address
    const addressInput = document.getElementById(`${type}_address`);
    if (addressInput) {
        addressInput.value = addressInfo.display_name;
    }

    // Update coordinates
    document.getElementById(`${type}_lat`).value = addressInfo.lat;
    document.getElementById(`${type}_lng`).value = addressInfo.lon;

    // Update hidden fields
    document.getElementById(`${type}_display_name`).value = addressInfo.display_name;
    document.getElementById(`${type}_coordinates`).value = `${addressInfo.lat},${addressInfo.lon}`;
    document.getElementById(`${type}_formatted_address`).value = addressInfo.display_name;

    // Update map markers and route
    updateMap();
}

// Function to handle search result selection
async function selectSearchResult(result) {
    const latlng = L.latLng(result.lat, result.lon);
    
    // Update map view
    popupMap.setView(latlng, 16);
    
    // Add or move marker
    if (tempMarker) {
        popupMap.removeLayer(tempMarker);
    }
    tempMarker = L.marker(latlng).addTo(popupMap);
    
    // Store the address details for later use
    tempMarker.address = {
        display_name: result.display_name,
        lat: result.lat,
        lon: result.lon,
        address: result.address || {}
    };
    
    // Update search input and hide results
    searchInput.value = result.display_name;
    searchResults.style.display = 'none';

    // Update country and city fields
    await updateLocationFields(currentLocationSelection, tempMarker.address);
}

// Function to get address from coordinates
async function getAddressFromCoordinates(lat, lng) {
    try {
        const response = await fetch(`/reverse_geocode?lat=${lat}&lng=${lng}`);
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error getting address:', error);
        return null;
    }
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    if (!searchResults.contains(e.target) && e.target !== searchInput) {
        searchResults.style.display = 'none';
    }
});

// Add event listeners for city selects
document.addEventListener('DOMContentLoaded', function() {
    ['pickup', 'dropoff'].forEach(type => {
        const citySelect = document.getElementById(`${type}_city`);
        
        if (citySelect) {
            citySelect.addEventListener('change', function(e) {
                const selectedCity = e.target.value;
                const country = document.getElementById(`${type}_country`).value;
                
                // Update selected city tracking
                if (type === 'pickup') {
                    selectedPickupCity = selectedCity;
                    // Update dropoff city options
                    if (document.getElementById('dropoff_country').value === country) {
                        updateCities('dropoff');
                    }
                } else {
                    selectedDropoffCity = selectedCity;
                    // Update pickup city options
                    if (document.getElementById('pickup_country').value === country) {
                        updateCities('pickup');
                    }
                }
                
                // Only update marker position if a city is selected
                if (country && selectedCity && EAST_AFRICAN_CITIES[country] && EAST_AFRICAN_CITIES[country][selectedCity]) {
                    const coords = EAST_AFRICAN_CITIES[country][selectedCity];
                    
                    // Update marker on map only if no specific address is set
                    const marker = type === 'pickup' ? pickupMarker : dropoffMarker;
                    const addressInput = document.getElementById(`${type}_address`);
                    const hasSpecificAddress = addressInput.value && 
                                            addressInput.value !== `${selectedCity}, ${country}` &&
                                            marker.address?.display_name !== `${selectedCity}, ${country}`;
                    
                    if (!hasSpecificAddress) {
                        const latlng = L.latLng(coords.lat, coords.lng);
                        
                        if (!marker.getLatLng()) {
                            marker.addTo(map);
                        }
                        marker.setLatLng(latlng);
                        
                        // Update coordinates and address only if no specific address
                        document.getElementById(`${type}_lat`).value = coords.lat;
                        document.getElementById(`${type}_lng`).value = coords.lng;
                        
                        // Store city-level address information
                        marker.address = {
                            display_name: `${selectedCity}, ${country}`,
                            lat: coords.lat,
                            lon: coords.lng,
                            address: {
                                city: selectedCity,
                                country: country
                            }
                        };
                    }
                    
                    // Update route if both markers exist
                    if (pickupMarker.getLatLng() && dropoffMarker.getLatLng()) {
                        updateRoute();
                    }
                }
            });
        }
    });
});

// Update the country change event to reset selected cities when country changes
['pickup', 'dropoff'].forEach(type => {
    const countrySelect = document.getElementById(`${type}_country`);
    if (countrySelect) {
        countrySelect.addEventListener('change', () => {
            if (type === 'pickup') {
                selectedPickupCity = null;
            } else {
                selectedDropoffCity = null;
            }
            updateCities(type);
        });
    }
});

// Add keyframe animation for shake effect
const style = document.createElement('style');
style.textContent = `
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}
.animate-shake {
    animation: shake 0.3s ease-in-out;
}`;
document.head.appendChild(style);

// Add validation functions for step 1
function validateStep1() {
    const pickupLat = document.getElementById('pickup_lat').value;
    const pickupLng = document.getElementById('pickup_lng').value;
    const dropoffLat = document.getElementById('dropoff_lat').value;
    const dropoffLng = document.getElementById('dropoff_lng').value;
    const pickupAddress = document.getElementById('pickup_address').value;
    const dropoffAddress = document.getElementById('dropoff_address').value;
    
    let isValid = true;
    let errors = [];
    
    // Clear previous error states
    clearValidationErrors();
    
    // Validate pickup location
    if (!pickupLat || !pickupLng || !pickupAddress) {
        isValid = false;
        errors.push('Please select a pickup location');
        highlightError('pickup_address', 'Please select a valid pickup location');
    }
    
    // Validate dropoff location
    if (!dropoffLat || !dropoffLng || !dropoffAddress) {
        isValid = false;
        errors.push('Please select a dropoff location');
        highlightError('dropoff_address', 'Please select a valid dropoff location');
    }
    
    // Validate that pickup and dropoff are not the same
    if (isValid && 
        pickupLat === dropoffLat && 
        pickupLng === dropoffLng) {
        isValid = false;
        errors.push('Pickup and dropoff locations cannot be the same');
        highlightError('pickup_address', 'Pickup and dropoff locations must be different');
        highlightError('dropoff_address', 'Pickup and dropoff locations must be different');
    }
    
    // Show error summary if needed
    if (!isValid) {
        showErrorSummary(errors);
        return false;
    }
    
    return true;
}

function clearValidationErrors() {
    // Remove error classes from inputs
    const inputs = document.querySelectorAll('.error');
    inputs.forEach(input => {
        input.classList.remove('error');
        const errorMessage = input.parentElement.querySelector('.error-message');
        if (errorMessage) {
            errorMessage.remove();
        }
    });
    
    // Clear error summary
    const errorSummary = document.getElementById('error-summary');
    if (errorSummary) {
        errorSummary.style.display = 'none';
    }
}

function highlightError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.add('error');
        
        // Add error message below the input
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message text-red-500 text-sm mt-1';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i>${message}`;
        element.parentElement.appendChild(errorDiv);
    }
}

function showErrorSummary(errors) {
    let errorSummary = document.getElementById('error-summary');
    
    // Create error summary if it doesn't exist
    if (!errorSummary) {
        errorSummary = document.createElement('div');
        errorSummary.id = 'error-summary';
        errorSummary.className = 'bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded';
        document.querySelector('.step-content.active').insertBefore(
            errorSummary,
            document.querySelector('.step-content.active').firstChild
        );
    }
    
    // Update error summary content
    errorSummary.innerHTML = `
        <div class="flex items-center mb-2">
            <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
            <h3 class="text-red-800 font-semibold">Please fix the following errors:</h3>
        </div>
        <ul class="list-disc list-inside text-red-700">
            ${errors.map(error => `<li>${error}</li>`).join('')}
        </ul>
    `;
    errorSummary.style.display = 'block';
    
    // Smooth scroll to error summary
    errorSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Add close modal function
function closeSuccessModal() {
    const successModal = document.getElementById('successModal');
    successModal.classList.add('hidden');
    
    // Show the form section again
    const formSection = document.querySelector('.py-16');
    formSection.style.display = 'block';
    
    // Reset form if needed
    document.getElementById('quote-form').reset();
    
    // Reset map markers
    if (pickupMarker && pickupMarker.getLatLng()) {
        map.removeLayer(pickupMarker);
    }
    if (dropoffMarker && dropoffMarker.getLatLng()) {
        map.removeLayer(dropoffMarker);
    }
    if (routeLine) {
        map.removeLayer(routeLine);
    }
    
    // Reset progress and steps
    const steps = document.querySelectorAll('.step');
    steps.forEach((step, index) => {
        if (index === 0) {
            step.classList.add('active');
        } else {
            step.classList.remove('active', 'completed');
        }
    });
    
    // Show first step
    const contents = document.querySelectorAll('.step-content');
    contents.forEach((content, index) => {
        if (index === 0) {
            content.classList.add('active');
            content.style.opacity = '1';
        } else {
            content.classList.remove('active');
        }
    });
    
    // Reset progress bar
    updateProgress(1);
}
</script>
{% endblock %}