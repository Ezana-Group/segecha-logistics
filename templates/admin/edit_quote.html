{% extends "base.html" %}

{% block title %}Edit Quote - Segecha Group Ltd.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .map-container {
        height: 300px;
        width: 100%;
        border-radius: 0.25rem;
        position: relative;
    }
    .map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .map-error {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 1rem;
        color: #991B1B;
        z-index: 1000;
    }
    .spinner {
        width: 2rem;
        height: 2rem;
        border: 3px solid #ddd;
        border-top-color: #3B82F6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .location-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0.25rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .location-suggestions.active {
        display: block;
    }
    .suggestion-item {
        padding: 0.5rem;
        cursor: pointer;
    }
    .suggestion-item:hover {
        background: #f3f4f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white shadow">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-between py-4">
            <span class="text-2xl font-bold text-brand-primary">Edit Quote</span>
            <nav class="flex space-x-4">
                <a href="{{ url_for('admin_dashboard') }}" 
                   class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                </a>
            </nav>
        </div>
    </div>
</div>

<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow p-6">
        <form method="POST" class="space-y-6">
            <!-- Customer Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Name *</label>
                    <input type="text" name="name" id="name" required
                           value="{{ quote.name }}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="company" class="block text-sm font-medium text-gray-700">Company</label>
                    <input type="text" name="company" id="company"
                           value="{{ quote.company }}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email *</label>
                    <input type="email" name="email" id="email" required
                           value="{{ quote.email }}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone *</label>
                    <input type="tel" name="phone" id="phone" required
                           value="{{ quote.phone }}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
            </div>

            <!-- Pickup Location -->
            <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-900">Pickup Location</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="pickup_country" class="block text-sm font-medium text-gray-700">Country *</label>
                        <select name="pickup_country" id="pickup_country" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select Country</option>
                            {% for country in countries %}
                            <option value="{{ country }}" {% if country == pickup_country %}selected{% endif %}>{{ country }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="pickup_city" class="block text-sm font-medium text-gray-700">City *</label>
                        <select name="pickup_city" id="pickup_city" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select City</option>
                            {% if pickup_country %}
                                {% for city in EAST_AFRICAN_CITIES[pickup_country].keys() %}
                                <option value="{{ city }}" {% if city == pickup_city %}selected{% endif %}>{{ city }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div>
                        <label for="pickup_address" class="block text-sm font-medium text-gray-700">Address *</label>
                        <input type="text" name="pickup_address" id="pickup_address" required
                               value="{{ pickup_address }}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                <input type="hidden" name="pickup_lat" id="pickup_lat" value="{{ quote.pickup_lat }}">
                <input type="hidden" name="pickup_lng" id="pickup_lng" value="{{ quote.pickup_lng }}">
            </div>

            <!-- Dropoff Location -->
            <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-900">Delivery Location</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="dropoff_country" class="block text-sm font-medium text-gray-700">Country *</label>
                        <select name="dropoff_country" id="dropoff_country" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select Country</option>
                            {% for country in countries %}
                            <option value="{{ country }}" {% if country == dropoff_country %}selected{% endif %}>{{ country }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="dropoff_city" class="block text-sm font-medium text-gray-700">City *</label>
                        <select name="dropoff_city" id="dropoff_city" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select City</option>
                            {% if dropoff_country %}
                                {% for city in EAST_AFRICAN_CITIES[dropoff_country].keys() %}
                                <option value="{{ city }}" {% if city == dropoff_city %}selected{% endif %}>{{ city }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div>
                        <label for="dropoff_address" class="block text-sm font-medium text-gray-700">Address *</label>
                        <input type="text" name="dropoff_address" id="dropoff_address" required
                               value="{{ dropoff_address }}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                <input type="hidden" name="dropoff_lat" id="dropoff_lat" value="{{ quote.dropoff_lat }}">
                <input type="hidden" name="dropoff_lng" id="dropoff_lng" value="{{ quote.dropoff_lng }}">
            </div>

            <!-- Route Map -->
            <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-900">Route Map</h3>
                <div id="map" class="map-container"></div>
                <input type="hidden" name="estimated_distance" id="estimated_distance" value="{{ quote.estimated_distance }}">
            </div>

            <!-- Cargo Information -->
            <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-900">Cargo Information</h3>
                <div>
                    <label for="cargo_description" class="block text-sm font-medium text-gray-700">Cargo Description *</label>
                    <textarea name="cargo_description" id="cargo_description" rows="3" required
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ quote.cargo_description }}</textarea>
                </div>
                <div>
                    <label for="preferred_date" class="block text-sm font-medium text-gray-700">Preferred Pickup Date</label>
                    <input type="date" name="preferred_date" id="preferred_date"
                           value="{{ quote.preferred_date.strftime('%Y-%m-%d') if quote.preferred_date else '' }}"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="additional_notes" class="block text-sm font-medium text-gray-700">Additional Notes</label>
                    <textarea name="additional_notes" id="additional_notes" rows="3"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ quote.additional_notes }}</textarea>
                </div>
            </div>

            <div class="flex justify-end space-x-4">
                <a href="{{ url_for('admin_dashboard') }}" 
                   class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Update Quote
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Initialize global variables
let map, pickupMarker, dropoffMarker, routeLayer;

// Polyline decoding function
function decodePolyline(str, precision) {
    var index = 0,
        lat = 0,
        lng = 0,
        coordinates = [],
        shift = 0,
        result = 0,
        byte = null,
        latitude_change,
        longitude_change,
        factor = Math.pow(10, precision || 5);

    while (index < str.length) {
        byte = null;
        shift = 0;
        result = 0;

        do {
            byte = str.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
        } while (byte >= 0x20);

        latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));
        shift = result = 0;

        do {
            byte = str.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
        } while (byte >= 0x20);

        longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lat += latitude_change;
        lng += longitude_change;
        coordinates.push([lat / factor, lng / factor]);
    }

    return coordinates;
}

function initMap() {
    // Initialize the map
    map = L.map('map').setView([0, 35], 5);  // Centered on East Africa
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Initialize markers
    const pickupLat = parseFloat(document.getElementById('pickup_lat').value) || 0;
    const pickupLng = parseFloat(document.getElementById('pickup_lng').value) || 0;
    const dropoffLat = parseFloat(document.getElementById('dropoff_lat').value) || 0;
    const dropoffLng = parseFloat(document.getElementById('dropoff_lng').value) || 0;

    if (pickupLat && pickupLng) {
        pickupMarker = L.marker([pickupLat, pickupLng], {
            draggable: true,
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="background-color: #3B82F6; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                iconSize: [12, 12]
            })
        }).addTo(map);
        pickupMarker.on('dragend', function(e) {
            updatePickupCoords(e);
            updateRoute();
        });
    }

    if (dropoffLat && dropoffLng) {
        dropoffMarker = L.marker([dropoffLat, dropoffLng], {
            draggable: true,
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="background-color: #10B981; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                iconSize: [12, 12]
            })
        }).addTo(map);
        dropoffMarker.on('dragend', function(e) {
            updateDropoffCoords(e);
            updateRoute();
        });
    }

    // Fit bounds if both markers exist
    if (pickupMarker && dropoffMarker) {
        const bounds = L.latLngBounds([
            [pickupLat, pickupLng],
            [dropoffLat, dropoffLng]
        ]);
        map.fitBounds(bounds, { padding: [50, 50] });
        updateRoute();
    }

    // Set up location search
    setupLocationSearch('pickup');
    setupLocationSearch('dropoff');
}

async function updateRoute() {
    if (!pickupMarker || !dropoffMarker) return;
    
    const pickup = pickupMarker.getLatLng();
    const dropoff = dropoffMarker.getLatLng();
    
    try {
        // Remove existing route if any
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        // Fetch route from OSRM
        const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${pickup.lng},${pickup.lat};${dropoff.lng},${dropoff.lat}?overview=full&geometries=polyline`);
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
            // Decode the polyline
            const coordinates = decodePolyline(data.routes[0].geometry);
            
            // Create and add the route layer
            routeLayer = L.polyline(coordinates, {
                color: '#3B82F6',
                weight: 4,
                opacity: 0.7,
                lineJoin: 'round'
            }).addTo(map);
            
            // Update distance if available
            if (data.routes[0].distance) {
                const distanceKm = (data.routes[0].distance / 1000).toFixed(1);
                const durationHours = (data.routes[0].duration / 3600).toFixed(1);
                routeLayer.bindPopup(`Distance: ${distanceKm} km<br>Estimated time: ${durationHours} hours`);
                document.getElementById('estimated_distance').value = distanceKm;
            }
        }
    } catch (error) {
        console.error('Error fetching route:', error);
    }
}

function updatePickupCoords(e) {
    const latlng = e.target.getLatLng();
    document.getElementById('pickup_lat').value = latlng.lat;
    document.getElementById('pickup_lng').value = latlng.lng;
}

function updateDropoffCoords(e) {
    const latlng = e.target.getLatLng();
    document.getElementById('dropoff_lat').value = latlng.lat;
    document.getElementById('dropoff_lng').value = latlng.lng;
}

function setupLocationSearch(type) {
    const countrySelect = document.getElementById(`${type}_country`);
    const citySelect = document.getElementById(`${type}_city`);
    const addressInput = document.getElementById(`${type}_address`);
    
    countrySelect.addEventListener('change', function() {
        const country = this.value;
        citySelect.innerHTML = '<option value="">Select City</option>';
        
        if (country && window.EAST_AFRICAN_CITIES[country]) {
            Object.keys(window.EAST_AFRICAN_CITIES[country]).forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }
    });
    
    citySelect.addEventListener('change', function() {
        const country = countrySelect.value;
        const city = this.value;
        
        if (country && city && window.EAST_AFRICAN_CITIES[country][city]) {
            const coords = window.EAST_AFRICAN_CITIES[country][city];
            const lat = coords.lat;
            const lng = coords.lng;
            
            if (type === 'pickup') {
                if (pickupMarker) {
                    pickupMarker.setLatLng([lat, lng]);
                } else {
                    pickupMarker = L.marker([lat, lng], {
                        draggable: true,
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: '<div style="background-color: #3B82F6; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                            iconSize: [12, 12]
                        })
                    }).addTo(map);
                    pickupMarker.on('dragend', function(e) {
                        updatePickupCoords(e);
                        updateRoute();
                    });
                }
                document.getElementById('pickup_lat').value = lat;
                document.getElementById('pickup_lng').value = lng;
            } else {
                if (dropoffMarker) {
                    dropoffMarker.setLatLng([lat, lng]);
                } else {
                    dropoffMarker = L.marker([lat, lng], {
                        draggable: true,
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: '<div style="background-color: #10B981; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                            iconSize: [12, 12]
                        })
                    }).addTo(map);
                    dropoffMarker.on('dragend', function(e) {
                        updateDropoffCoords(e);
                        updateRoute();
                    });
                }
                document.getElementById('dropoff_lat').value = lat;
                document.getElementById('dropoff_lng').value = lng;
            }
            
            if (pickupMarker && dropoffMarker) {
                updateRoute();
                const bounds = L.latLngBounds([
                    pickupMarker.getLatLng(),
                    dropoffMarker.getLatLng()
                ]);
                map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                map.setView([lat, lng], 13);
            }
        }
    });
}

// Initialize map when the page loads
document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %} 