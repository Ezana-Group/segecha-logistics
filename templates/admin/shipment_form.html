{% extends "base.html" %}

{% block title %}{% if shipment %}Edit{% else %}New{% endif %} Shipment - Admin Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
<style>
    .map-container {
        height: 400px;
        margin-bottom: 1rem;
    }
    .location-suggestions {
        position: absolute;
        z-index: 1000;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }
    .location-suggestions.active {
        display: block;
    }
    .location-suggestion {
        padding: 0.5rem 1rem;
        cursor: pointer;
    }
    .location-suggestion:hover {
        background-color: #f3f4f6;
    }
    .location-input-container {
        position: relative;
    }
    /* Time picker styles */
    .time-picker-container {
        position: relative;
    }
    .time-picker-container input {
        padding-right: 2.5rem;
    }
    .time-picker-container::after {
        content: '\f017';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
    }
    /* Flatpickr customization */
    .flatpickr-calendar {
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .flatpickr-day.selected {
        background: #3B82F6;
        border-color: #3B82F6;
    }
    .flatpickr-day:hover {
        background: #EFF6FF;
    }

    /* Loading states */
    .loading {
        position: relative;
        pointer-events: none;
    }
    .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    .loading::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 24px;
        height: 24px;
        border: 2px solid #3B82F6;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 11;
    }
    @keyframes spin {
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Form feedback */
    .form-feedback {
        display: none;
        padding: 0.75rem;
        margin-top: 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    .form-feedback.error {
        display: block;
        background-color: #FEE2E2;
        color: #DC2626;
        border: 1px solid #FCA5A5;
    }
    .form-feedback.success {
        display: block;
        background-color: #D1FAE5;
        color: #059669;
        border: 1px solid #A7F3D0;
    }

    /* Improved input states */
    .input-group {
        position: relative;
    }
    .input-group input:focus + .input-focus-ring {
        opacity: 1;
        transform: scale(1);
    }
    .input-focus-ring {
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border: 2px solid #3B82F6;
        border-radius: 0.375rem;
        opacity: 0;
        transform: scale(0.95);
        transition: all 0.2s ease;
        pointer-events: none;
    }

    /* Improved button states */
    .btn {
        position: relative;
        overflow: hidden;
    }
    .btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
    }
    .btn:focus:not(:active)::after {
        animation: ripple 1s ease-out;
    }
    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }
        100% {
            transform: scale(20, 20);
            opacity: 0;
        }
    }

    /* Improved select styling */
    .select-wrapper {
        position: relative;
    }
    .select-wrapper::after {
        content: '\f107';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
    }
    select {
        appearance: none;
        padding-right: 2.5rem;
    }

    /* Map Modal */
    .map-modal {
        @apply fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40;
    }

    .map-modal-content {
        @apply bg-white rounded-lg shadow-lg w-full max-w-2xl;
    }

    .map-modal-header {
        @apply flex justify-between items-center px-6 py-4 border-b;
    }

    .map-modal-body {
        @apply px-6 py-4;
    }

    .map-search-input {
        @apply w-full px-4 py-2 pr-10 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-3;
    }

    .map-container {
        @apply h-[350px] rounded-lg border border-gray-200;
    }

    /* Loading State */
    .btn-loading {
        @apply opacity-75 cursor-not-allowed;
    }

    .btn-loading .spinner {
        @apply animate-spin -ml-1 mr-2 h-4 w-4;
    }

    /* Custom Marker */
    .custom-marker {
        @apply w-3 h-3 rounded-full border-2 border-white shadow-lg;
    }

    .custom-marker.pickup {
        @apply bg-blue-600;
    }

    .custom-marker.dropoff {
        @apply bg-green-600;
    }

    /* Map Controls */
    .leaflet-control-zoom {
        @apply shadow-lg rounded-lg overflow-hidden;
    }

    .leaflet-control-zoom a {
        @apply bg-white hover:bg-gray-100 text-gray-700 border-gray-200;
    }

    /* Responsive Grid */
    @media (min-width: 640px) {
        .location-grid {
            @apply grid-cols-6 gap-6;
        }
    }

    /* Animation */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .fade-in {
        animation: fadeIn 0.2s ease-in-out;
    }

    /* Focus States */
    .form-input:focus, .form-select:focus {
        @apply ring-2 ring-blue-500 border-blue-500;
    }

    /* Required Field Indicator */
    .required-field::after {
        content: " *";
        @apply text-red-500;
    }

    /* Custom Scrollbar for Modal */
    .map-modal-content {
        @apply overflow-hidden;
    }

    .map-modal-body {
        max-height: calc(100vh - 200px);
        @apply overflow-y-auto;
    }

    .map-modal-body::-webkit-scrollbar {
        @apply w-2;
    }

    .map-modal-body::-webkit-scrollbar-track {
        @apply bg-gray-100 rounded-full;
    }

    .map-modal-body::-webkit-scrollbar-thumb {
        @apply bg-gray-300 rounded-full hover:bg-gray-400;
    }

    /* Remove map controls styles */
    .map-controls,
    .route-info,
    .map-control-btn,
    .route-info-header,
    .route-info-content,
    .route-info-item {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white shadow">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-between py-4">
            <span class="text-xl font-bold text-brand-primary">Admin Dashboard</span>
            <nav class="flex space-x-4">
            <a href="{{ url_for('admin_dashboard') }}" 
               class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50">
                <i class="fas fa-home mr-2"></i>Dashboard
            </a>
            <a href="{{ url_for('admin_shipments') }}" 
               class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50">
                <i class="fas fa-truck mr-2"></i>Shipments
            </a>
            <a href="{{ url_for('new_shipment') }}" 
               class="px-3 py-2 rounded-md text-sm font-medium bg-blue-100 text-blue-700">
                <i class="fas fa-plus mr-2"></i>New Shipment
            </a>
        </nav>
    </div>
</div>

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-semibold text-gray-900">{% if shipment %}Edit{% else %}Create New{% endif %} Shipment</h1>
            <a href="{{ url_for('admin_shipments') }}" 
               class="text-blue-600 hover:text-blue-900">
                Back to Shipments
            </a>
        </div>

        <form method="POST" class="mt-8 bg-white shadow rounded-lg divide-y divide-gray-200">
            <!-- Customer Information -->
            <div class="p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Customer Information</h2>
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                    <div class="sm:col-span-2">
                        <label for="customer_name" class="block text-sm font-medium text-gray-700">Customer Name</label>
                        <input type="text" 
                               name="customer_name" 
                               id="customer_name"
                               value="{% if shipment %}{{ shipment.customer_name }}{% elif quote_request %}{{ quote_request.name }}{% endif %}"
                               required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Pickup Location -->
            <div class="p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-truck text-blue-600 text-xl mr-2"></i>
                    Pickup Location
                </h2>
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                    <div class="sm:col-span-3">
                        <label for="pickup_country" class="block text-sm font-medium text-gray-700">Country *</label>
                        <select name="pickup_country" id="pickup_country" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" data-selected="{{ shipment.pickup_country if shipment else '' }}">
                            <option value="">Select Country</option>
                            {% for country in countries %}
                            <option value="{{ country }}" {% if shipment and shipment.pickup_country == country %}selected{% endif %}>{{ country }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="sm:col-span-3">
                        <label for="pickup_city" class="block text-sm font-medium text-gray-700">City/Town *</label>
                        <select name="pickup_city" id="pickup_city" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" data-selected="{{ shipment.pickup_city if shipment else '' }}">
                            <option value="">Select City</option>
                        </select>
                    </div>
                    <div class="sm:col-span-6">
                        <label for="pickup_address" class="block text-sm font-medium text-gray-700">Specific Address *</label>
                        <div class="mt-1 flex gap-2">
                            <div class="flex-grow relative">
                                <input type="text" 
                                       name="pickup_address" 
                                       id="pickup_address" 
                                       required 
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 pr-10" 
                                       value="{% if shipment %}{{ shipment.pickup_address }}{% elif quote_request %}{{ quote_request.pickup_address }}{% endif %}" 
                                       placeholder="Start typing to search address...">
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none">
                                    <i class="fas fa-map-marker-alt text-gray-400"></i>
                                </div>
                            </div>
                            <button type="button" 
                                    class="inline-flex items-center px-4 py-2 border border-blue-100 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                    onclick="openMapModal('pickup')">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                Pin on Map
                            </button>
                        </div>
                        <input type="hidden" name="pickup_lat" id="pickup_lat" value="{% if shipment %}{{ shipment.pickup_lat }}{% elif quote_request %}{{ quote_request.pickup_lat }}{% endif %}">
                        <input type="hidden" name="pickup_lng" id="pickup_lng" value="{% if shipment %}{{ shipment.pickup_lng }}{% elif quote_request %}{{ quote_request.pickup_lng }}{% endif %}">
                    </div>
                    <!-- Pickup Schedule -->
                    <div class="sm:col-span-6 bg-gray-50 rounded-lg p-4 mt-4">
                        <h4 class="text-md font-medium text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>
                            Pickup Schedule
                        </h4>
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <!-- Pickup Date -->
                            <div class="relative">
                                <label for="pickup_date" class="block text-sm font-medium text-gray-700 mb-2">Pickup Date</label>
                                <div class="relative rounded-md shadow-sm">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-calendar text-gray-400"></i>
                                    </div>
                                    <input type="date" 
                                           id="pickup_date" 
                                           name="pickup_date" 
                                           class="block w-full pl-10 pr-4 py-2.5 text-base rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                                           value="{{ shipment.pickup_date.strftime('%Y-%m-%d') if shipment and shipment.pickup_date else '' }}"
                                           min="{{ now.strftime('%Y-%m-%d') }}">
                                </div>
                            </div>
                            
                            <!-- Pickup Time -->
                            <div class="relative">
                                <label for="pickup_time" class="block text-sm font-medium text-gray-700 mb-2">Pickup Time</label>
                                <div class="relative rounded-md shadow-sm">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-clock text-gray-400"></i>
                                    </div>
                                    <input type="text" 
                                           id="pickup_time" 
                                           name="pickup_time" 
                                           class="block w-full pl-10 pr-4 py-2.5 text-base rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                                           placeholder="Select time"
                                           value="{{ shipment.pickup_time if shipment and shipment.pickup_time else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delivery Location -->
            <div class="p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-flag-checkered text-green-600 text-xl mr-2"></i>
                    Drop-off Location
                </h2>
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                    <div class="sm:col-span-3">
                        <label for="dropoff_country" class="block text-sm font-medium text-gray-700">Country *</label>
                        <select name="dropoff_country" id="dropoff_country" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" data-selected="{{ shipment.dropoff_country if shipment else '' }}">
                            <option value="">Select Country</option>
                            {% for country in countries %}
                            <option value="{{ country }}" {% if shipment and shipment.dropoff_country == country %}selected{% endif %}>{{ country }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="sm:col-span-3">
                        <label for="dropoff_city" class="block text-sm font-medium text-gray-700">City/Town *</label>
                        <select name="dropoff_city" id="dropoff_city" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" data-selected="{{ shipment.dropoff_city if shipment else '' }}">
                            <option value="">Select City</option>
                        </select>
                    </div>
                    <div class="sm:col-span-6">
                        <label for="dropoff_address" class="block text-sm font-medium text-gray-700">Specific Address *</label>
                        <div class="mt-1 flex gap-2">
                            <div class="flex-grow relative">
                                <input type="text" 
                                       name="dropoff_address" 
                                       id="dropoff_address" 
                                       required 
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 pr-10" 
                                       value="{% if shipment %}{{ shipment.dropoff_address }}{% elif quote_request %}{{ quote_request.dropoff_address }}{% endif %}" 
                                       placeholder="Start typing to search address...">
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none">
                                    <i class="fas fa-map-marker-alt text-gray-400"></i>
                                </div>
                            </div>
                            <button type="button" 
                                    class="inline-flex items-center px-4 py-2 border border-blue-100 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                    onclick="openMapModal('dropoff')">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                Pin on Map
                            </button>
                        </div>
                        <input type="hidden" name="dropoff_lat" id="dropoff_lat" value="{% if shipment %}{{ shipment.dropoff_lat }}{% elif quote_request %}{{ quote_request.dropoff_lat }}{% endif %}">
                        <input type="hidden" name="dropoff_lng" id="dropoff_lng" value="{% if shipment %}{{ shipment.dropoff_lng }}{% elif quote_request %}{{ quote_request.dropoff_lng }}{% endif %}">
                    </div>
                    <!-- Delivery Schedule -->
                    <div class="sm:col-span-6 bg-gray-50 rounded-lg p-4 mt-4">
                        <h4 class="text-md font-medium text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-truck-loading text-green-600 mr-2"></i>
                            Estimated Delivery Schedule
                        </h4>
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <!-- Delivery Date -->
                            <div class="relative">
                                <label for="estimated_delivery_date" class="block text-sm font-medium text-gray-700 mb-2">Delivery Date</label>
                                <div class="relative rounded-md shadow-sm">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-calendar text-gray-400"></i>
                                    </div>
                                    <input type="date" 
                                           id="estimated_delivery_date" 
                                           name="estimated_delivery_date" 
                                           class="block w-full pl-10 pr-4 py-2.5 text-base rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                                           value="{{ shipment.estimated_delivery.strftime('%Y-%m-%d') if shipment and shipment.estimated_delivery else '' }}"
                                           min="{{ now.strftime('%Y-%m-%d') }}">
                                </div>
                            </div>
                            
                            <!-- Delivery Time -->
                            <div class="relative">
                                <label for="estimated_delivery_time" class="block text-sm font-medium text-gray-700 mb-2">Delivery Time</label>
                                <div class="relative rounded-md shadow-sm">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-clock text-gray-400"></i>
                                    </div>
                                    <input type="text" 
                                           id="estimated_delivery_time" 
                                           name="estimated_delivery_time" 
                                           class="block w-full pl-10 pr-4 py-2.5 text-base rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                                           placeholder="Select time"
                                           value="{{ shipment.estimated_delivery.strftime('%H:%M') if shipment and shipment.estimated_delivery else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Location (for existing shipments) -->
            {% if shipment %}
            <div class="p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Current Location</h2>
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                    <div class="sm:col-span-6">
                        <label for="current_location" class="block text-sm font-medium text-gray-700">Location Description</label>
                        <input type="text" 
                               name="current_location" 
                               id="current_location"
                               value="{{ shipment.current_location }}"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <input type="hidden" name="current_lat" id="current_lat" value="{{ shipment.current_lat }}">
                    <input type="hidden" name="current_lng" id="current_lng" value="{{ shipment.current_lng }}">
                </div>
            </div>
            {% endif %}

            <!-- Shipment Details -->
            <div class="p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Shipment Details</h2>
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                    <div class="sm:col-span-6">
                        <label for="cargo_description" class="block text-sm font-medium text-gray-700">Cargo Description</label>
                        <textarea name="cargo_description" 
                                  id="cargo_description"
                                  rows="3"
                                  required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{% if shipment %}{{ shipment.cargo_description }}{% elif quote_request %}{{ quote_request.cargo_description }}{% endif %}</textarea>
                    </div>

                    <div class="sm:col-span-3">
                        <label for="weight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                        <div class="relative rounded-md shadow-sm">
                            <input type="number" 
                                   name="weight" 
                                   id="weight" 
                                   value="{{ shipment.weight if shipment else '' }}"
                                   min="0"
                                   step="0.01"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">kg</span>
                            </div>
                        </div>
                    </div>

                    <div class="sm:col-span-3">
                        <label for="dimensions" class="block text-sm font-medium text-gray-700">Dimensions (L×W×H)</label>
                        <div class="relative rounded-md shadow-sm">
                            <input type="text" 
                                   name="dimensions" 
                                   id="dimensions" 
                                   value="{{ shipment.dimensions if shipment else '' }}"
                                   placeholder="e.g., 100×50×30"
                                   pattern="\d+×\d+×\d+"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">cm</span>
                            </div>
                        </div>
                    </div>

                    <div class="sm:col-span-3">
                        <label for="cargo_type" class="block text-sm font-medium text-gray-700">Cargo Type</label>
                        <select name="cargo_type" 
                                id="cargo_type" 
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select Type</option>
                            <option value="General" {% if shipment and shipment.cargo_type == 'General' %}selected{% endif %}>General Cargo</option>
                            <option value="Fragile" {% if shipment and shipment.cargo_type == 'Fragile' %}selected{% endif %}>Fragile</option>
                            <option value="Hazardous" {% if shipment and shipment.cargo_type == 'Hazardous' %}selected{% endif %}>Hazardous</option>
                            <option value="Refrigerated" {% if shipment and shipment.cargo_type == 'Refrigerated' %}selected{% endif %}>Refrigerated</option>
                            <option value="Oversized" {% if shipment and shipment.cargo_type == 'Oversized' %}selected{% endif %}>Oversized</option>
                        </select>
                    </div>

                    <div class="sm:col-span-3">
                        <label for="volume" class="block text-sm font-medium text-gray-700">Volume</label>
                        <div class="relative rounded-md shadow-sm">
                            <input type="number" 
                                   name="volume" 
                                   id="volume" 
                                   value="{{ shipment.volume if shipment else '' }}"
                                   min="0"
                                   step="0.01"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">m³</span>
                            </div>
                        </div>
                    </div>

                    <div class="sm:col-span-3">
                        <label for="is_insured" class="block text-sm font-medium text-gray-700">Insurance</label>
                        <select name="is_insured" 
                                id="is_insured" 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                onchange="toggleInsurancePrice(this.value)">
                            <option value="">Select</option>
                            <option value="1" {% if shipment and shipment.is_insured %}selected{% endif %}>Insured</option>
                            <option value="0" {% if shipment and not shipment.is_insured %}selected{% endif %}>Not Insured</option>
                        </select>
                    </div>

                    <div class="sm:col-span-3" id="insurance_price_container" style="display: none;">
                        <label for="insurance_price" class="block text-sm font-medium text-gray-700">Insurance Price</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">$</span>
                            </div>
                            <input type="number" 
                                   name="insurance_price" 
                                   id="insurance_price" 
                                   value="{{ shipment.insurance_price if shipment else '' }}"
                                   min="0"
                                   step="0.01"
                                   class="mt-1 block w-full pl-7 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="sm:col-span-3">
                        <label for="vehicle_plate" class="block text-sm font-medium text-gray-700">Vehicle Plate Number</label>
                        <input type="text" 
                               name="vehicle_plate" 
                               id="vehicle_plate"
                               value="{{ shipment.vehicle_plate if shipment else '' }}"
                               placeholder="e.g., KBZ 123A"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <div class="sm:col-span-3">
                        <label for="pickup_status" class="block text-sm font-medium text-gray-700">Pickup Status</label>
                        <select name="pickup_status" 
                                id="pickup_status"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="Pending" {% if shipment and shipment.pickup_status == 'Pending' %}selected{% endif %}>Pending</option>
                            <option value="Picked Up" {% if shipment and shipment.pickup_status == 'Picked Up' %}selected{% endif %}>Picked Up</option>
                        </select>
                    </div>

                    <div class="sm:col-span-6">
                        <label for="pickup_notes" class="block text-sm font-medium text-gray-700">Pickup Notes</label>
                        <textarea name="pickup_notes" 
                                  id="pickup_notes"
                                  rows="2"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{ shipment.pickup_notes if shipment else '' }}</textarea>
                    </div>

                    <div class="sm:col-span-6">
                        <label for="notes" class="block text-sm font-medium text-gray-700">Additional Notes</label>
                        <textarea name="notes" 
                                  id="notes"
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{% if shipment %}{{ shipment.notes }}{% elif quote_request %}{{ quote_request.additional_notes }}{% endif %}</textarea>
                    </div>
                </div>
            </div>

            {% if quote_request %}
            <input type="hidden" name="quote_request_id" value="{{ quote_request.id }}">
            {% endif %}

            <!-- Map -->
            <div class="p-6">
                <div id="map" class="map-container rounded-lg border border-gray-300"></div>
            </div>

            <!-- Map Modal -->
            <div id="mapModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
                <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl relative">
                    <div class="flex justify-between items-center px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold" id="mapModalTitle">Select Location on Map</h3>
                        <button class="text-gray-400 hover:text-gray-700 text-2xl leading-none" onclick="closeMapModal()">&times;</button>
                    </div>
                    <div class="px-6 py-4">
                        <div class="mb-4">
                            <p class="text-gray-600 mb-2">Search for an address or click on the map to place a marker.</p>
                            <div class="relative">
                                <input id="modalAddressSearch" 
                                       type="text" 
                                       placeholder="Search for an address..." 
                                       class="w-full px-4 py-2 pr-10 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                <div class="absolute inset-y-0 right-3 flex items-center">
                                    <button type="button" onclick="searchModalAddress()" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="searchResults" class="absolute z-10 w-full bg-white border border-gray-200 rounded-md shadow-lg mt-1 hidden">
                                <!-- Search results will be populated here -->
                            </div>
                        </div>
                        <div id="modalMap" class="h-[350px] rounded-lg border border-gray-200"></div>
                        <div class="flex justify-end mt-4 gap-2">
                            <button class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" onclick="closeMapModal()">Cancel</button>
                            <button class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="confirmMapModal()">Confirm Location</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="px-6 py-4 bg-gray-50 flex justify-end">
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    {% if shipment %}Save Changes{% else %}Create Shipment{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
let map, pickupMarker, dropoffMarker;
let modalMap, modalMarker, modalType;
let searchTimeout;

// Initialize EAST_AFRICAN_CITIES data
window.EAST_AFRICAN_CITIES = {{ EAST_AFRICAN_CITIES|tojson|safe }};

// Initialize main map
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the main map
    map = L.map('map').setView([0, 35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Initialize markers if coordinates exist
    const pickupLat = document.getElementById('pickup_lat').value;
    const pickupLng = document.getElementById('pickup_lng').value;
    const dropoffLat = document.getElementById('dropoff_lat').value;
    const dropoffLng = document.getElementById('dropoff_lng').value;

    if (pickupLat && pickupLng) {
        pickupMarker = L.marker([parseFloat(pickupLat), parseFloat(pickupLng)], {
            icon: createCustomIcon('pickup')
        }).addTo(map);
    }

    if (dropoffLat && dropoffLng) {
        dropoffMarker = L.marker([parseFloat(dropoffLat), parseFloat(dropoffLng)], {
            icon: createCustomIcon('dropoff')
        }).addTo(map);
    }

    // If both markers exist, show route and fit bounds
    if (pickupMarker && dropoffMarker) {
        updateMap();
    }

    // Initialize country/city dropdowns
    setupLocationDropdowns('pickup');
    setupLocationDropdowns('dropoff');
    
    // Initialize map
    initializeMap();

    // Initialize date pickers
    flatpickr("#pickup_date", {
        dateFormat: "Y-m-d",
        minDate: "today",
        onChange: function(selectedDates, dateStr) {
            const deliveryDatePicker = document.getElementById('estimated_delivery_date')._flatpickr;
            deliveryDatePicker.set('minDate', dateStr);
        }
    });

    flatpickr("#estimated_delivery_date", {
        dateFormat: "Y-m-d",
        minDate: "today"
    });

    // Initialize time pickers with specific configurations
    flatpickr("#pickup_time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        minuteIncrement: 15,
        defaultHour: 9,
        defaultMinute: 0,
        onChange: function(selectedDates, timeStr) {
            const pickupDate = document.getElementById('pickup_date').value;
            const deliveryDate = document.getElementById('estimated_delivery_date').value;
            if (pickupDate && deliveryDate && pickupDate === deliveryDate) {
                deliveryTimePicker.set('minTime', timeStr);
            }
        }
    });

    const deliveryTimePicker = flatpickr("#estimated_delivery_time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        minuteIncrement: 15,
        defaultHour: 17,
        defaultMinute: 0
    });

    // Add validation for delivery time when dates are the same
    document.getElementById('estimated_delivery_date').addEventListener('change', function() {
        const pickupDate = document.getElementById('pickup_date').value;
        const pickupTime = document.getElementById('pickup_time').value;
        if (this.value === pickupDate && pickupTime) {
            deliveryTimePicker.set('minTime', pickupTime);
        } else {
            deliveryTimePicker.set('minTime', "00:00");
        }
    });

    // Pre-select cities if editing
    const pickupCountry = document.getElementById('pickup_country');
    const dropoffCountry = document.getElementById('dropoff_country');
    
    if (pickupCountry.value) {
        updateCityOptions('pickup', pickupCountry.value, pickupCountry.dataset.selected);
    }
    if (dropoffCountry.value) {
        updateCityOptions('dropoff', dropoffCountry.value, dropoffCountry.dataset.selected);
    }
});

function setupLocationDropdowns(type) {
    const countrySelect = document.getElementById(`${type}_country`);
    const citySelect = document.getElementById(`${type}_city`);
    const addressInput = document.getElementById(`${type}_address`);
    
    // Handle country change
    countrySelect.addEventListener('change', function() {
        const country = this.value;
        const selectedCity = citySelect.dataset.selected;
        updateCityOptions(type, country, selectedCity);
    });
    
    // Handle city selection changes
    citySelect.addEventListener('change', function() {
        const country = countrySelect.value;
        const city = this.value;
        
        if (country && city && window.EAST_AFRICAN_CITIES[country]?.[city]) {
            const coords = window.EAST_AFRICAN_CITIES[country][city];
            document.getElementById(`${type}_lat`).value = coords.lat;
            document.getElementById(`${type}_lng`).value = coords.lng;
            addressInput.value = `${city}, ${country}`;
            
            if (type === 'pickup') {
                if (!pickupMarker) {
                    pickupMarker = L.marker([coords.lat, coords.lng], {
                        icon: createCustomIcon('pickup')
                    }).addTo(map);
                } else {
                    pickupMarker.setLatLng([coords.lat, coords.lng]);
                }
            } else {
                if (!dropoffMarker) {
                    dropoffMarker = L.marker([coords.lat, coords.lng], {
                        icon: createCustomIcon('dropoff')
                    }).addTo(map);
                } else {
                    dropoffMarker.setLatLng([coords.lat, coords.lng]);
                }
            }
            updateMap();
        }
    });
    
    // Handle address input changes
    addressInput.addEventListener('change', function() {
        const lat = document.getElementById(`${type}_lat`).value;
        const lng = document.getElementById(`${type}_lng`).value;
        
        if (lat && lng) {
            if (type === 'pickup') {
                if (!pickupMarker) {
                    pickupMarker = L.marker([parseFloat(lat), parseFloat(lng)], {
                        icon: createCustomIcon('pickup')
                    }).addTo(map);
                } else {
                    pickupMarker.setLatLng([parseFloat(lat), parseFloat(lng)]);
                }
            } else {
                if (!dropoffMarker) {
                    dropoffMarker = L.marker([parseFloat(lat), parseFloat(lng)], {
                        icon: createCustomIcon('dropoff')
                    }).addTo(map);
                } else {
                    dropoffMarker.setLatLng([parseFloat(lat), parseFloat(lng)]);
                }
            }
            updateMap();
        }
    });
}

function updateCityOptions(type, country, selectedCity = '') {
    const citySelect = document.getElementById(`${type}_city`);
    citySelect.innerHTML = '<option value="">Select City</option>';
    citySelect.disabled = !country;
    
    if (country && window.EAST_AFRICAN_CITIES[country]) {
        Object.keys(window.EAST_AFRICAN_CITIES[country]).forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            if (city === selectedCity) {
                option.selected = true;
            }
            citySelect.appendChild(option);
        });
        
        // If we have a selected city, trigger the change event
        if (selectedCity && window.EAST_AFRICAN_CITIES[country][selectedCity]) {
            citySelect.dispatchEvent(new Event('change'));
        }
    }
}

function openMapModal(type) {
    modalType = type;
    const modal = document.getElementById('mapModal');
    const title = document.getElementById('mapModalTitle');
    title.textContent = `Select ${type === 'pickup' ? 'Pickup' : 'Drop-off'} Location`;
    modal.classList.remove('hidden');
    
    setTimeout(() => {
        if (!modalMap) {
            modalMap = L.map('modalMap').setView([0, 35], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(modalMap);
            
            modalMap.on('click', function(e) {
                setModalMarker(e.latlng.lat, e.latlng.lng);
                reverseGeocode(e.latlng.lat, e.latlng.lng);
            });
        }
        
        modalMap.invalidateSize();
        
        // Set marker to current value if available
        const lat = document.getElementById(`${type}_lat`).value;
        const lng = document.getElementById(`${type}_lng`).value;
        if (lat && lng) {
            setModalMarker(parseFloat(lat), parseFloat(lng));
            modalMap.setView([parseFloat(lat), parseFloat(lng)], 13);
            reverseGeocode(parseFloat(lat), parseFloat(lng));
        }
    }, 100);
    
    // Setup search input
    const searchInput = document.getElementById('modalAddressSearch');
    searchInput.value = document.getElementById(`${type}_address`).value;
    setupModalSearch(searchInput);
}

function setupModalSearch(searchInput) {
    searchInput.addEventListener('input', function() {
        if (searchTimeout) clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 3) return;
        
        searchTimeout = setTimeout(() => {
            const country = document.getElementById(`${modalType}_country`).value;
            searchLocation(query, country);
        }, 500);
    });

    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = this.value.trim();
            if (query.length < 3) return;
            
            const country = document.getElementById(`${modalType}_country`).value;
            searchLocation(query, country);
        }
    });
}

async function searchLocation(query, country) {
    try {
        const searchInput = document.getElementById('modalAddressSearch');
        searchInput.classList.add('loading');
        
        const params = new URLSearchParams({
            query: query,
            country: country || ''
        });
        
        const response = await fetch(`/search_address?${params}`);
        const results = await response.json();
        
        if (results.length > 0) {
            const location = results[0];
            
            // Update marker position
            setModalMarker(parseFloat(location.lat), parseFloat(location.lon));
            modalMap.setView([parseFloat(location.lat), parseFloat(location.lon)], 15);
            
            // Show full address in search input
            searchInput.value = location.display_name || location.formatted_address;
            
            // Store coordinates in hidden fields
            document.getElementById(`${modalType}_lat`).value = location.lat;
            document.getElementById(`${modalType}_lng`).value = location.lon;
        }
    } catch (error) {
        console.error('Error searching location:', error);
    } finally {
        document.getElementById('modalAddressSearch').classList.remove('loading');
    }
}

function setModalMarker(lat, lng) {
    if (modalMarker) {
        modalMarker.setLatLng([lat, lng]);
    } else {
        modalMarker = L.marker([lat, lng], {
            draggable: true,
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="marker-pin ${modalType}">
                    <div class="marker-pulse ${modalType}"></div>
                    <div style="background-color: ${modalType === 'pickup' ? '#3B82F6' : '#10B981'}; 
                         width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>
                </div>`,
                iconSize: [12, 12]
            })
        }).addTo(modalMap);
        
        modalMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            reverseGeocode(pos.lat, pos.lng);
        });
    }
}

async function reverseGeocode(lat, lng) {
    try {
        const searchInput = document.getElementById('modalAddressSearch');
        const mainInput = document.getElementById(`${modalType}_address`);
        searchInput.classList.add('loading');
        
        const response = await fetch(`/reverse_geocode?lat=${lat}&lng=${lng}`);
        const data = await response.json();
        
        const address = data.display_name || data.formatted_address;
        
        // Update both the modal search input and the main form input
        searchInput.value = address;
        mainInput.value = address;
        
        // Store coordinates
        document.getElementById(`${modalType}_lat`).value = lat;
        document.getElementById(`${modalType}_lng`).value = lng;
        
        // Update the map marker
        if (modalType === 'pickup' && pickupMarker) {
            pickupMarker.setLatLng([lat, lng]);
        } else if (modalType === 'dropoff' && dropoffMarker) {
            dropoffMarker.setLatLng([lat, lng]);
        }
        
        updateMap();
    } catch (error) {
        console.error('Error reverse geocoding:', error);
        searchInput.value = 'Address not found. Please try again or enter manually.';
    } finally {
        searchInput.classList.remove('loading');
    }
}

function closeMapModal() {
    document.getElementById('mapModal').classList.add('hidden');
    if (modalMarker) {
        modalMap.removeLayer(modalMarker);
        modalMarker = null;
    }
}

function confirmMapModal() {
    if (!modalMarker) return;
    
    const pos = modalMarker.getLatLng();
    const address = document.getElementById('modalAddressSearch').value;
    
    // Update the main form fields
    document.getElementById(`${modalType}_address`).value = address;
    document.getElementById(`${modalType}_lat`).value = pos.lat;
    document.getElementById(`${modalType}_lng`).value = pos.lng;
    
    // Update the map marker
    if (modalType === 'pickup') {
        if (!pickupMarker) {
            pickupMarker = L.marker([pos.lat, pos.lng], {
                icon: createCustomIcon('pickup')
            }).addTo(map);
        } else {
            pickupMarker.setLatLng([pos.lat, pos.lng]);
        }
    } else {
        if (!dropoffMarker) {
            dropoffMarker = L.marker([pos.lat, pos.lng], {
                icon: createCustomIcon('dropoff')
            }).addTo(map);
        } else {
            dropoffMarker.setLatLng([pos.lat, pos.lng]);
        }
    }
    
    closeMapModal();
    updateMap();
}

function createCustomIcon(type) {
    const color = type === 'pickup' ? '#3B82F6' : '#10B981';
    return L.divIcon({
        className: 'custom-div-icon',
        html: `<div class="w-6 h-6 relative">
                <div class="absolute inset-0 bg-${type === 'pickup' ? 'blue' : 'green'}-200 rounded-full animate-ping opacity-75"></div>
                <div class="relative w-4 h-4 bg-${type === 'pickup' ? 'blue' : 'green'}-600 rounded-full border-2 border-white shadow-lg"></div>
               </div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });
}

let routeLayer = null;

async function updateMap() {
    if (!pickupMarker || !dropoffMarker) return;

    const pickup = pickupMarker.getLatLng();
    const dropoff = dropoffMarker.getLatLng();

    try {
        // Remove existing route if any
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }

        // Fetch route from backend
        const response = await fetch(`/get_route?start_lng=${pickup.lng}&start_lat=${pickup.lat}&end_lng=${dropoff.lng}&end_lat=${dropoff.lat}`);
        const data = await response.json();

        if (data.success) {
            // Create route layer using the geometry
            const coordinates = decodePolyline(data.geometry);
            routeLayer = L.polyline(coordinates, {
                color: '#3B82F6',
                weight: 4,
                opacity: 0.7,
                lineJoin: 'round'
            }).addTo(map);

            // Add distance and duration popup to the route
            const midpoint = coordinates[Math.floor(coordinates.length / 2)];
            L.popup({
                closeButton: false,
                className: 'route-info-popup'
            })
            .setLatLng(midpoint)
            .setContent(`
                <div class="text-sm font-medium">
                    <div class="text-gray-900">Distance: ${data.distance} km</div>
                    <div class="text-gray-600">Est. time: ${data.duration} hours</div>
                </div>
            `)
            .openOn(map);

            // Fit map bounds to show the entire route with padding
            const bounds = routeLayer.getBounds();
            map.fitBounds(bounds, {
                padding: [50, 50]
            });
        }
    } catch (error) {
        console.error('Error updating route:', error);
    }
}

// Polyline decoding function (required for OSRM geometry)
function decodePolyline(str, precision = 5) {
    let index = 0,
        lat = 0,
        lng = 0,
        coordinates = [],
        shift = 0,
        result = 0,
        byte = null,
        latitude_change,
        longitude_change,
        factor = Math.pow(10, precision);

    // Coordinates have variable length when encoded, so just keep
    // track of whether we've hit the end of the string. In each
    // loop iteration, a single coordinate is decoded.
    while (index < str.length) {
        // Reset shift, result, and byte
        byte = null;
        shift = 0;
        result = 0;

        do {
            byte = str.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
        } while (byte >= 0x20);

        latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

        shift = result = 0;

        do {
            byte = str.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
        } while (byte >= 0x20);

        longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

        lat += latitude_change;
        lng += longitude_change;

        coordinates.push([lat / factor, lng / factor]);
    }

    return coordinates;
}

// Add styles for the route info popup
const style = document.createElement('style');
style.textContent = `
    .route-info-popup .leaflet-popup-content-wrapper {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .route-info-popup .leaflet-popup-tip {
        background-color: white;
    }
    .route-info-popup .leaflet-popup-content {
        margin: 8px 12px;
    }
`;
document.head.appendChild(style);

// Add loading state to form submission
document.querySelector('form').addEventListener('submit', function(e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
});
</script>
{% endblock %}
{% endblock %} 